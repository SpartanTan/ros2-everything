<?xml version="1.0"?>
<robot name="my_robot" xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- Select hardware backend: can | topic -->
  <xacro:arg  name="simulation" default="true"/>
  <xacro:property  name="simulation" value="$(arg simulation)"/>

  <link name="base_link"/>
  <link name="left_wheel_link"/>
  <link name="right_wheel_link"/>

  <joint name="left_wheel_joint" type="continuous">
    <parent link="base_link"/>
    <child link="left_wheel_link"/>
    <origin xyz="0 0.2 0" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
  </joint>

  <joint name="right_wheel_joint" type="continuous">
    <parent link="base_link"/>
    <child link="right_wheel_link"/>
    <origin xyz="0 -0.2 0" rpy="0 0 0"/>
    <axis xyz="0 1 0"/>
  </joint>

  <!-- Topic-based backend -->
  <xacro:if value="${simulation}">
    <ros2_control name="MyRobotSystem" type="system">
      <hardware>
        <plugin>topic_based_ros2_control/TopicBasedSystem</plugin>
        <param name="joint_commands_topic">/diffbot_joint_command</param>
        <param name="joint_states_topic">/diffbot_joint_states</param>
        <param name="sum_wrapped_joint_states">true</param>
        <param name="trigger_joint_command_threshold">-1</param>.
      </hardware>

      <joint name="left_wheel_joint">
        <command_interface name="velocity"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>

      <joint name="right_wheel_joint">
        <command_interface name="velocity"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
    </ros2_control>
  </xacro:if>

  <!-- CAN backend -->
  <xacro:unless value="${simulation}">
    <ros2_control name="MyRobotSystem" type="system">
      <hardware>
        <plugin>my_robot_hardware/CanSystem</plugin>
        <param name="can_interface">can0</param>
        <param name="left_can_id">0x201</param>
        <param name="right_can_id">0x202</param>
      </hardware>

      <joint name="left_wheel_joint">
        <command_interface name="velocity"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>

      <joint name="right_wheel_joint">
        <command_interface name="velocity"/>
        <state_interface name="position"/>
        <state_interface name="velocity"/>
      </joint>
    </ros2_control>
  </xacro:unless>

</robot>
